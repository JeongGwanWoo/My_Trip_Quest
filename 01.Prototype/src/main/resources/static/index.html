<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripQuest ë¯¸ì…˜</title>
    <style>
	    body {
	        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
	        margin: 0;
	        background-color: #f4f7f6;
	        color: #333;
	        font-size: clamp(14px, 2.5vw, 16px); /* ë°˜ì‘í˜• í°íŠ¸ í¬ê¸° */
	    }
	    #user-info {
	        position: fixed;
	        top: 0;
	        left: 0;
	        right: 0;
	        width: auto;
	        height: 60px;
	        background-color: white;
	        padding: 0 20px;
	        border-bottom: 1px solid #eef;
	        z-index: 100;
	        display: flex;
	        justify-content: flex-end;
	        align-items: center;
	    }
	    #user-info span {
	        font-weight: bold;
	    }
	    #user-info > .separator {
	        margin: 0 10px;
	    }
	    .main-container {
	        display: flex;
	        flex-direction: column;
	        align-items: center;
	        padding: 80px 10px 20px 10px; /* Add padding for fixed header */
	        gap: 15px;
	    }
	    .mission-card, .container {
	        text-align: center;
	        padding: 20px;
	        border-radius: 10px;
	        background-color: #fff;
	        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	        width: 95%;
	        max-width: 500px;
	    }
	    h1, h2 {
	        color: #2c3e50;
	        margin-top: 0;
	        font-size: clamp(20px, 4vw, 24px); /* ë°˜ì‘í˜• í°íŠ¸ í¬ê¸° */
	    }
	    .input-group {
	        margin-bottom: 15px;
	    }
	    label {
	        display: block;
	        margin-bottom: 5px;
	        font-weight: bold;
	    }
	
	    /* [ìˆ˜ì •] ì¼ë°˜ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (select ì œì™¸) */
	    input[type="text"], input[type="file"] {
	        box-sizing: border-box; 
	        width: 100%;
	        min-width: 0;
	        padding: 10px;
	        border: 1px solid #ccc;
	        border-radius: 5px;
	        font-size: clamp(14px, 2.5vw, 16px); 
	    }
	
	    /* [ì¶”ê°€] ë“œë¡­ë‹¤ìš´(Select) ì „ìš© ìŠ¤íƒ€ì¼ */
	    select {
	        box-sizing: border-box;
	        width: auto;      /* ê¸€ì ê¸¸ì´ì— ë§ì¶° í¬ê¸° ì¡°ì ˆ */
	        min-width: 150px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
	        max-width: 100%;  /* í™”ë©´ì„ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ì œí•œ */
	        
	        padding: 10px 35px 10px 15px; /* ì˜¤ë¥¸ìª½ ì—¬ë°±ì€ í™”ì‚´í‘œ ê³µê°„ */
	        border: 1px solid #ccc;
	        border-radius: 5px;
	        font-size: clamp(14px, 2.5vw, 16px);
	        background-color: #fff;
	        cursor: pointer;
	        
	        /* ëª¨ë°”ì¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° (ì•„ì´í°/ì•ˆë“œë¡œì´ë“œ íšŒìƒ‰ë°•ìŠ¤ ì œê±°) */
	        -webkit-appearance: none;
	        -moz-appearance: none;
	        appearance: none;
	        
	        /* ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ì•„ì´ì½˜ */
	        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
	        background-repeat: no-repeat;
	        background-position: right 10px center;
	        background-size: 16px;
	    }
	
	    select:focus {
	        outline: none;
	        border-color: #3498db;
	        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
	    }
	
	    button {
	        background-color: #3498db;
	        color: white;
	        border: none;
	        padding: 12px 20px;
	        border-radius: 5px;
	        cursor: pointer;
	        font-size: 16px;
	        margin: 5px 0;
	        transition: background-color 0.3s;
	        width: 100%;
	    }
	    button:hover {
	        background-color: #2980b9;
	    }
	    .location-display {
	        margin: 15px 0;
	        font-size: 14px;
	        color: #555;
	        background-color: #f9f9f9;
	        padding: 10px;
	        border-radius: 5px;
	    }
	    .result {
	        margin-top: 15px;
	        font-size: 16px;
	        font-weight: bold;
	    }
	    .success { color: #27ae60; }
	    .error { color: #c0392b; }
	    
	    #character-display {
	        position: relative;
	        width: 120px;
	        height: 180px;
	        margin: 20px auto;
	    }
	
	    #character-image {
	        width: 100%;
	        height: auto;
	    }
	    .mission-header {
	        display: flex;
	        justify-content: space-between;
	        align-items: baseline;
	        border-bottom: 1px solid #eee;
	        padding-bottom: 10px;
	        margin-bottom: 15px;
	    }
	    .mission-header h2 { margin-bottom: 0; }
	    .mission-reward {
	        font-size: 14px;
	        font-weight: bold;
	        color: #e67e22;
	    }
	    .mission-description {
	        font-size: 14px;
	        color: #555;
	        margin-bottom: 15px;
	    }
	</style>
</head>
<body>

    <div id="user-info">
        <span><span id="user-nickname">?</span>ë‹˜</span>
        <span class="separator">|</span>
        <span>í¬ì¸íŠ¸: <span id="user-points">?</span> P</span>
    </div>

    <main class="main-container" id="main-container">
        <div class="container" id="spot-selection-container">
            <label for="spot-selector">ê´€ê´‘ì§€ ì„ íƒ:</label>
            <select id="spot-selector"></select>
        </div>
        <!-- Mission cards will be dynamically inserted here -->
        
        <div class="container" id="character-container">
            <h2>ğŸ§‘â€ğŸ¨ ë‚´ ìºë¦­í„°</h2>
            <div id="character-display">
                <img id="character-image" src="" alt="ë‚´ ìºë¦­í„°"/>
            </div>
            <button id="toggle-hat-btn">ëª¨ì ì°©ìš©/í•´ì œ</button>
            <button id="toggle-sunglasses-btn">ì„ ê¸€ë¼ìŠ¤ ì°©ìš©/í•´ì œ</button>
            <div id="character-status" style="margin-top: 10px;"></div>
        </div>
    </main>

    <script>
        console.log('--- TripQuest ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ---');

        const mainContainer = document.getElementById('main-container');
        const userNicknameSpan = document.getElementById('user-nickname');
        const userPointsSpan = document.getElementById('user-points');
        const characterImage = document.getElementById('character-image');
        const toggleHatBtn = document.getElementById('toggle-hat-btn');
        const toggleSunglassesBtn = document.getElementById('toggle-sunglasses-btn');
        const characterStatusDiv = document.getElementById('character-status');
        const spotSelector = document.getElementById('spot-selector');
        const currentUserId = 1;

        function convertDistanceToDisplayString(distanceInMeters) {
            if (distanceInMeters >= 1000) {
                const distanceInKm = distanceInMeters / 1000;
                return `${distanceInKm.toFixed(2)}km`;
            }
            return `${distanceInMeters.toFixed(1)}m`;
        }

        async function fetchAndShowUser() {
            try {
                const response = await fetch(`/api/users/${currentUserId}`);
                if (!response.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì‹¤íŒ¨');
                const user = await response.json();
                
                userNicknameSpan.textContent = user.nickname;
                userPointsSpan.textContent = user.pointBalance;

                characterStatusDiv.textContent = (user.characterCustomization && user.characterCustomization !== '{}')
                    ? `ì°©ìš© ì¤‘: ${user.characterCustomization}`
                    : 'ì•„ë¬´ê²ƒë„ ì°©ìš©í•˜ì§€ ì•ŠìŒ';
                fetchCharacterImage();
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }
        
        async function fetchCharacterImage() {
            try {
                characterImage.src = `/api/users/${currentUserId}/character-image?t=${new Date().getTime()}`;
            } catch (error) {
                console.error('ìºë¦­í„° ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
            }
        }

        async function saveCharacterState(accessoryName) {
            try {
                const response = await fetch(`/api/users/${currentUserId}/character-customization`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessory: accessoryName }),
                });
                if (response.ok) {
                    fetchAndShowUser();
                } else {
                    console.error(`ì•¡ì„¸ì„œë¦¬ '${accessoryName}' ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:`, await response.text());
                }
            } catch (error) {
                console.error(`API í˜¸ì¶œ ì˜¤ë¥˜: ${accessoryName}`, error);
            }
        }

        function createMissionCard(mission) {
            const card = document.createElement('div');
            card.className = 'mission-card';
            card.id = `mission-card-${mission.missionId}`;

            let controlsHtml = '';
            if (mission.missionType === 'ARRIVAL') {
                controlsHtml = `
                    <button class="get-location-btn" data-spot-no="${mission.spotNo}">1. ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
                    <div class="location-display">
                        ìœ„ë„: <span class="latitude">?</span><br>
                        ê²½ë„: <span class="longitude">?</span>
                    </div>
                    <button class="verify-arrival-btn" data-spot-no="${mission.spotNo}">2. ë„ì°© í™•ì¸</button>
                `;
            } else if (mission.missionType === 'PHOTO') {
                controlsHtml = `
                    <div class="input-group">
                        <label for="photoFile-${mission.missionId}">ì¸ì¦ ì‚¬ì§„ ì„ íƒ:</label>
                        <input type="file" class="photo-file-input" id="photoFile-${mission.missionId}" accept="image/*">
                    </div>
                    <img class="image-preview" src="" alt="Image preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none;">
                    <button class="submit-photo-btn" data-mission-id="${mission.missionId}">ì‚¬ì§„ ì œì¶œ</button>
                `;
            }

            card.innerHTML = `
                <div class="mission-header">
                    <h2>${mission.title}</h2>
                    <span class="mission-reward">âœ¨ ${mission.rewardPoint}P</span>
                </div>
                <p class="mission-description">${mission.description}</p>
                ${controlsHtml}
                <div class="result"></div>
            `;
            mainContainer.insertBefore(card, document.getElementById('character-container'));
        }

        async function fetchAndRenderMissions(spotNo) {
            // Clear existing mission cards
            document.querySelectorAll('.mission-card').forEach(card => card.remove());

            if (!spotNo) {
                console.log('ì„ íƒëœ ê´€ê´‘ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const response = await fetch(`/api/spots/${spotNo}/missions`);
                if (!response.ok) throw new Error(`'${spotNo}'ë²ˆ ê´€ê´‘ì§€ ë¯¸ì…˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨`);
                const missions = await response.json();
                missions.forEach(createMissionCard);
                addEventListenersToCards();
            } catch (error) {
                console.error('ë¯¸ì…˜ ëª©ë¡ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }

        async function fetchAndRenderSpots() {
            try {
                const response = await fetch('/api/spots');
                if (!response.ok) throw new Error('ê´€ê´‘ì§€ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨');
                const spots = await response.json();
                
                spotSelector.innerHTML = ''; // Clear previous options
                spots.forEach(spot => {
                    const option = document.createElement('option');
                    option.value = spot.no;
                    option.textContent = spot.title;
                    spotSelector.appendChild(option);
                });

                // Initially load missions for the first spot in the list
                if (spots.length > 0) {
                    fetchAndRenderMissions(spots[0].no);
                }

            } catch (error) {
                console.error('ê´€ê´‘ì§€ ëª©ë¡ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        }

        function addEventListenersToCards() {
            document.querySelectorAll('.get-location-btn').forEach(btn => {
                btn.addEventListener('click', handleGetLocation);
            });
            document.querySelectorAll('.verify-arrival-btn').forEach(btn => {
                btn.addEventListener('click', handleVerifyArrival);
            });
            document.querySelectorAll('.photo-file-input').forEach(input => {
                input.addEventListener('change', handlePhotoPreview);
            });
            document.querySelectorAll('.submit-photo-btn').forEach(btn => {
                btn.addEventListener('click', handleSubmitPhoto);
            });
        }
        
        function handleGetLocation(event) {
            const card = event.target.closest('.mission-card');
            const resultDiv = card.querySelector('.result');
            if (navigator.geolocation) {
                resultDiv.textContent = 'ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        card.querySelector('.latitude').textContent = position.coords.latitude.toFixed(6);
                        card.querySelector('.longitude').textContent = position.coords.longitude.toFixed(6);
                        resultDiv.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. ë„ì°© í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                        resultDiv.className = 'result success';
                    },
                    () => {
                        resultDiv.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        resultDiv.className = 'result error';
                    }
                );
            } else {
                resultDiv.textContent = 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                resultDiv.className = 'result error';
            }
        }

        async function handleVerifyArrival(event) {
            const card = event.target.closest('.mission-card');
            const resultDiv = card.querySelector('.result');
            const spotNo = event.target.dataset.spotNo;
            const lat = card.querySelector('.latitude').textContent;
            const lon = card.querySelector('.longitude').textContent;

            if (lat === '?' || lon === '?') {
                resultDiv.textContent = 'ë¨¼ì € ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì£¼ì„¸ìš”.';
                resultDiv.className = 'result error';
                return;
            }
            
            resultDiv.textContent = 'ì„œë²„ì— ë„ì°© í™•ì¸ ìš”ì²­ ì¤‘...';
            try {
                const response = await fetch(`/api/spots/${spotNo}/verify-arrival`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: parseFloat(lat), longitude: parseFloat(lon) })
                });
                const data = await response.json();
                const displayDistance = convertDistanceToDisplayString(data.distance);
                if (response.ok) {
                    resultDiv.textContent = `ğŸ‰ ${data.message} (ê±°ë¦¬: ${displayDistance})`;
                    resultDiv.className = 'result success';
                    fetchAndShowUser();
                } else {
                    resultDiv.textContent = `âŒ ${data.message} (ê±°ë¦¬: ${displayDistance})`;
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.textContent = 'ë„ì°© ë¯¸ì…˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                resultDiv.className = 'result error';
            }
        }

        function handlePhotoPreview(event) {
            const card = event.target.closest('.mission-card');
            const preview = card.querySelector('.image-preview');
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                card.querySelector('.result').textContent = '';
            }
        }

        async function submitPhotoRequest(card, missionId, file, currentLat, currentLon) {
            const resultDiv = card.querySelector('.result');
            const formData = new FormData();
            formData.append('file', file);

            let url = `/api/missions/photo/${missionId}?userId=${currentUserId}`;
            if (currentLat !== undefined && currentLon !== undefined) {
                url += `&latitude=${currentLat}&longitude=${currentLon}`;
            }

            resultDiv.textContent = 'ì‚¬ì§„ì„ ì œì¶œí•˜ê³  ë¶„ì„í•˜ëŠ” ì¤‘...';
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    resultDiv.textContent = `ğŸ‰ ${data.message}`;
                    resultDiv.className = 'result success';
                    fetchAndShowUser();
                } else {
                    if (data.status === "METADATA_MISSING") {
                        resultDiv.innerHTML = `
                            <p class="error">${data.message}</p>
                            <button class="current-location-verify-btn" data-mission-id="${missionId}">ì˜ˆ, í˜„ì¬ ìœ„ì¹˜ë¡œ ì¸ì¦</button>
                            <button class="retry-btn">ì•„ë‹ˆìš”, ë‹¤ì‹œ ì‹œë„</button>
                        `;
                        card.querySelector('.current-location-verify-btn').addEventListener('click', (e) => {
                            const fileInput = card.querySelector('.photo-file-input');
                            const currentFile = fileInput.files[0];
                            if (!currentFile) {
                                resultDiv.textContent = 'ì˜¤ë¥˜: ì‚¬ì§„ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                                resultDiv.className = 'result error';
                                return;
                            }
                            handleCurrentLocationVerification(card, missionId, currentFile);
                        });
                        card.querySelector('.retry-btn').addEventListener('click', () => {
                            resultDiv.textContent = '';
                            resultDiv.className = 'result';
                        });
                    } else {
                        let errorMessage = `âŒ ë¯¸ì…˜ ì‹¤íŒ¨: ${data.message}`;
                        if (data.distance) {
                            errorMessage += ` (í˜„ì¬ ê±°ë¦¬: ${convertDistanceToDisplayString(data.distance)})`;
                        }
                        resultDiv.textContent = errorMessage;
                        resultDiv.className = 'result error';
                    }
                }
            } catch (error) {
                resultDiv.textContent = 'ì‚¬ì§„ ë¯¸ì…˜ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                resultDiv.className = 'result error';
            }
        }

        async function handleSubmitPhoto(event) {
            const card = event.target.closest('.mission-card');
            const missionId = event.target.dataset.missionId;
            const fileInput = card.querySelector('.photo-file-input');
            const file = fileInput.files[0];

            if (!file) {
                card.querySelector('.result').textContent = 'ë¨¼ì € ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                card.querySelector('.result').className = 'result error';
                return;
            }
            submitPhotoRequest(card, missionId, file);
        }

        function handleCurrentLocationVerification(card, missionId, file) {
            const resultDiv = card.querySelector('.result');
            if (navigator.geolocation) {
                resultDiv.textContent = 'í˜„ì¬ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
                resultDiv.className = 'result';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        submitPhotoRequest(card, missionId, file, lat, lon);
                    },
                    () => {
                        resultDiv.textContent = 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        resultDiv.className = 'result error';
                    }
                );
            } else {
                resultDiv.textContent = 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                resultDiv.className = 'result error';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndShowUser();
            fetchAndRenderSpots(); // Changed from fetchAndRenderMissions
            toggleHatBtn.addEventListener('click', () => saveCharacterState('wizard_hat'));
            toggleSunglassesBtn.addEventListener('click', () => saveCharacterState('sunglasses'));
            spotSelector.addEventListener('change', (event) => {
                fetchAndRenderMissions(event.target.value);
            });
        });
    </script>
</body>
</html>
