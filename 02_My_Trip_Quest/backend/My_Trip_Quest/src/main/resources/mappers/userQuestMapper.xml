<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mytripquest.domain.quest.repository.UserQuestRepository">

    <resultMap id="userQuestMap" type="com.mytripquest.domain.quest.entity.UserQuest">
        <id property="userQuestId" column="user_quest_id"/>
        <result property="userId" column="user_id"/>
        <result property="questId" column="quest_id"/>
        <result property="status" column="status" javaType="com.mytripquest.domain.quest.entity.QuestStatus"/>
        <result property="proofData" column="proof_data"/>
        <result property="acceptedAt" column="accepted_at"/>
        <result property="completedAt" column="completed_at"/>
        <result property="lastUpdatedAt" column="last_updated_at"/>
    </resultMap>

    <resultMap id="inProgressQuestDtoMap" type="com.mytripquest.domain.quest.dto.InProgressQuestDto">
        <constructor>
            <arg column="quest_id" javaType="long"/>
            <arg column="title" javaType="string"/>
            <arg column="status" javaType="com.mytripquest.domain.quest.entity.QuestStatus"/>
            <arg column="accepted_at" javaType="java.time.LocalDateTime"/>
            <arg column="location_name" javaType="string"/>
        </constructor>
    </resultMap>

    <select id="findByUserIdAndQuestId" resultMap="userQuestMap">
        SELECT *
        FROM user_quests
        WHERE user_id = #{userId} AND quest_id = #{questId}
    </select>

    <select id="findCompletedByUserIdAndQuestId" resultMap="userQuestMap">
        SELECT *
        FROM user_quests
        WHERE user_id = #{userId} AND quest_id = #{questId} AND status = 'COMPLETED'
    </select>

    <select id="countIncompleteLocationsByArea" resultType="int">
        SELECT
            COUNT(*)
        FROM
            locations l
        WHERE
            l.area_code = #{areaCode}
            AND (
                (SELECT COUNT(q.quest_id) FROM quests q WHERE q.location_id = l.location_id)
                >
                (SELECT COUNT(q2.quest_id) FROM user_quests uq
                JOIN quests q2 ON uq.quest_id = q2.quest_id
                WHERE q2.location_id = l.location_id
                AND uq.user_id = #{userId}
                AND uq.status = 'COMPLETED')
            )
    </select>

    <insert id="save" parameterType="com.mytripquest.domain.quest.entity.UserQuest" useGeneratedKeys="true" keyProperty="userQuestId">
        INSERT INTO user_quests (user_id, quest_id, status, accepted_at)
        VALUES (#{userId}, #{questId}, #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, NOW())
    </insert>

    <update id="update" parameterType="com.mytripquest.domain.quest.entity.UserQuest">
        UPDATE user_quests
        SET
            status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            completed_at = NOW(),
            last_updated_at = NOW()
        WHERE user_quest_id = #{userQuestId}
    </update>

    <select id="findUserQuestsByStatus" resultMap="inProgressQuestDtoMap">
        SELECT
            uq.quest_id,
            q.title,
            uq.status,
            uq.accepted_at,
            l.name as location_name
        FROM
            user_quests uq
        JOIN
            quests q ON uq.quest_id = q.quest_id
        JOIN
            locations l ON q.location_id = l.location_id
        WHERE
            uq.user_id = #{userId} AND uq.status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler}
        ORDER BY
            uq.accepted_at DESC
    </select>

</mapper>
